<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßò Meditation ECG Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.18.2/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #718096;
            font-size: 1.2em;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus, button:hover {
            border-color: #667eea;
            outline: none;
            transform: translateY(-1px);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            margin: 0 20px;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f7fafc;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }

        .tab:hover {
            background: #edf2f7;
        }

        .content {
            background: white;
            margin: 0 20px 20px 20px;
            border-radius: 0 0 15px 15px;
            min-height: 600px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }

        .summary-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .summary-card .unit {
            font-size: 0.9em;
            color: #718096;
        }

        .chart-container {
            margin: 20px 0;
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
        }

        .elements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .element-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 5px solid;
        }

        .element-percentage {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .frequency-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
        }

        .ecg-config {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .ecg-config h4 {
            color: #234e52;
            margin-bottom: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .config-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üßò Meditation ECG Analysis Dashboard</h1>
        <p>Lead II ECG Analysis with Panchamahabhutha Elements & HRV Metrics</p>
    </div>

    <div class="controls">
        <div class="control-row">
            <div class="control-group">
                <label for="fileSelect">üìÅ File:</label>
                <select id="fileSelect">
                    <option value="">Select a file...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="frequencySelect">üîä Frequency:</label>
                <select id="frequencySelect">
                    <option value="500">500 Hz</option>
                    <option value="1000" selected>1000 Hz</option>
                    <option value="2000">2000 Hz</option>
                </select>
            </div>
            
            <button onclick="compareFrequencies()">üìä Compare Frequencies</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('summary')">üìã Summary</button>
        <button class="tab" onclick="showTab('elements')">üåü Panchamahabhutha</button>
        <button class="tab" onclick="showTab('signal')">üìà ECG Signal</button>
        <button class="tab" onclick="showTab('hrv')">üíì HRV Analysis</button>
        <button class="tab" onclick="showTab('comparison')">‚öñÔ∏è Frequency Comparison</button>
    </div>

    <div class="content">
        <!-- Summary Tab -->
        <div id="summary" class="tab-content active">
            <div id="ecgConfig" class="ecg-config" style="display: none;">
                <h4>üî¨ ECG Configuration</h4>
                <div class="config-grid">
                    <div class="config-item"><strong>Lead Type:</strong> <span id="leadType"></span></div>
                    <div class="config-item"><strong>Setup:</strong> <span id="electrodeSetup"></span></div>
                    <div class="config-item"><strong>Negative:</strong> <span id="negativeElectrode"></span></div>
                    <div class="config-item"><strong>Positive:</strong> <span id="positiveElectrode"></span></div>
                    <div class="config-item"><strong>Ground:</strong> <span id="groundElectrode"></span></div>
                    <div class="config-item"><strong>Vector Angle:</strong> <span id="vectorAngle"></span></div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card">
                    <h3>üíì Heart Rate</h3>
                    <div class="value" id="heartRate">--</div>
                    <div class="unit">BPM</div>
                </div>
                
                <div class="summary-card">
                    <h3>üìà RMSSD</h3>
                    <div class="value" id="rmssd">--</div>
                    <div class="unit">ms</div>
                </div>
                
                <div class="summary-card">
                    <h3>üéØ FESI</h3>
                    <div class="value" id="fesi">--</div>
                    <div class="unit">Stress Index</div>
                </div>
                
                <div class="summary-card">
                    <h3>üõ°Ô∏è APPI</h3>
                    <div class="value" id="appi">--</div>
                    <div class="unit">Protection Index</div>
                </div>
                
                <div class="summary-card">
                    <h3>üîÑ pNN50</h3>
                    <div class="value" id="pnn50">--</div>
                    <div class="unit">%</div>
                </div>
                
                <div class="summary-card">
                    <h3>‚öñÔ∏è Rhythm Regularity</h3>
                    <div class="value" id="rhythmReg">--</div>
                    <div class="unit">Index</div>
                </div>
            </div>
            
            <div id="fileInfo" style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
                <h3>üìä File Information</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div><strong>Intervention:</strong> <span id="intervention">--</span></div>
                    <div><strong>Subject:</strong> <span id="subject">--</span></div>
                    <div><strong>Stage:</strong> <span id="stage">--</span></div>
                    <div><strong>Sampling Freq:</strong> <span id="samplingFreq">--</span></div>
                    <div><strong>Duration:</strong> <span id="duration">--</span></div>
                    <div><strong>Signal Quality:</strong> <span id="signalQuality">--</span></div>
                </div>
            </div>
        </div>

        <!-- Elements Tab -->
        <div id="elements" class="tab-content">
            <div class="elements-grid" id="elementsGrid">
                <!-- Elements will be populated here -->
            </div>
            
            <div class="chart-container">
                <canvas id="elementsChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Signal Tab -->
        <div id="signal" class="tab-content">
            <div class="chart-container">
                <div id="signalPlot" style="width: 100%; height: 600px;"></div>
            </div>
        </div>

        <!-- HRV Tab -->
        <div id="hrv" class="tab-content">
            <div class="chart-container">
                <canvas id="hrvChart" width="400" height="300"></canvas>
            </div>
            
            <div class="chart-container">
                <div id="rrHistogram" style="width: 100%; height: 400px;"></div>
            </div>
        </div>

        <!-- Comparison Tab -->
        <div id="comparison" class="tab-content">
            <div class="frequency-comparison">
                <div class="chart-container">
                    <canvas id="hrComparisonChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="hrvComparisonChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="fesiComparisonChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="elementsComparisonChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <p>üìÑ Loading ECG analysis data...</p>
    </div>

    <script>
        let ecgData = null;
        let currentResult = null;
        let charts = {};

        // Color schemes
        const elementColors = {
            'PRITHVI (Earth)': '#8B4513',
            'JAL (Water)': '#4169E1',
            'AGNI (Fire)': '#FF4500',
            'VAYU (Air)': '#32CD32',
            'AKASH (Space)': '#9932CC'
        };

        // Load data
        async function loadData() {
            try {
                const response = await fetch('ecg_analysis_data.json');
                ecgData = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                populateFileSelect();
                showECGConfig();
                updateDisplay();
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    '<div class="error">‚ùå Error loading data: ' + error.message + 
                    '<br>Make sure ecg_analysis_data.json is in the same folder</div>';
            }
        }

        function showECGConfig() {
            if (ecgData && ecgData.metadata && ecgData.metadata.ecg_config) {
                const config = ecgData.metadata.ecg_config;
                document.getElementById('leadType').textContent = config.lead_type;
                document.getElementById('electrodeSetup').textContent = config.electrode_setup;
                document.getElementById('negativeElectrode').textContent = config.negative_electrode;
                document.getElementById('positiveElectrode').textContent = config.positive_electrode;
                document.getElementById('groundElectrode').textContent = config.ground_electrode;
                document.getElementById('vectorAngle').textContent = config.vector_angle + '¬∞';
                document.getElementById('ecgConfig').style.display = 'block';
            }
        }

        function populateFileSelect() {
            const select = document.getElementById('fileSelect');
            select.innerHTML = '<option value="">Select a file...</option>';
            
            Object.keys(ecgData.results).forEach(fileId => {
                const fileInfo = ecgData.results[fileId].file_info;
                const displayName = `${fileInfo.intervention} - ${fileInfo.subject} - ${fileInfo.stage}`;
                const option = document.createElement('option');
                option.value = fileId;
                option.textContent = displayName;
                select.appendChild(option);
            });
        }

        function updateDisplay() {
            const fileId = document.getElementById('fileSelect').value;
            const frequency = document.getElementById('frequencySelect').value;
            
            if (!fileId || !frequency || !ecgData) return;
            
            const fileData = ecgData.results[fileId];
            if (!fileData || !fileData.frequencies[frequency]) {
                console.log('No data for', fileId, frequency);
                return;
            }
            
            currentResult = fileData.frequencies[frequency];
            
            updateSummaryTab();
            updateElementsTab();
            updateSignalTab();
            updateHRVTab();
        }

        function updateSummaryTab() {
            if (!currentResult) return;
            
            // Update metrics
            document.getElementById('heartRate').textContent = currentResult.heart_rate.toFixed(1);
            document.getElementById('rmssd').textContent = currentResult.hrv_features.RMSSD.toFixed(1);
            document.getElementById('fesi').textContent = currentResult.fesi.toFixed(1);
            document.getElementById('appi').textContent = currentResult.appi.toFixed(3);
            document.getElementById('pnn50').textContent = currentResult.hrv_features.pNN50.toFixed(1);
            document.getElementById('rhythmReg').textContent = currentResult.hrv_features.Rhythm_Regularity.toFixed(3);
            
            // Update file info
            document.getElementById('intervention').textContent = currentResult.file_info.intervention;
            document.getElementById('subject').textContent = currentResult.file_info.subject;
            document.getElementById('stage').textContent = currentResult.file_info.stage;
            document.getElementById('samplingFreq').textContent = currentResult.sample_freq + ' Hz';
            document.getElementById('duration').textContent = currentResult.duration.toFixed(1) + ' sec';
            document.getElementById('signalQuality').textContent = (currentResult.signal_quality * 100).toFixed(1) + '%';
        }

        function updateElementsTab() {
            if (!currentResult) return;
            
            const elementsGrid = document.getElementById('elementsGrid');
            elementsGrid.innerHTML = '';
            
            // Create element cards
            Object.entries(currentResult.elements).forEach(([element, percentage]) => {
                const card = document.createElement('div');
                card.className = 'element-card';
                card.style.borderTopColor = elementColors[element];
                
                const shortName = element.split('(')[0].trim();
                card.innerHTML = `
                    <h3>${shortName}</h3>
                    <div class="element-percentage" style="color: ${elementColors[element]}">${percentage.toFixed(1)}%</div>
                    <p>${ecgData.metadata.elements_definition[element].description}</p>
                `;
                elementsGrid.appendChild(card);
            });
            
            // Create pie chart
            updateElementsChart();
        }

        function updateElementsChart() {
            const ctx = document.getElementById('elementsChart').getContext('2d');
            
            if (charts.elements) {
                charts.elements.destroy();
            }
            
            const labels = Object.keys(currentResult.elements).map(e => e.split('(')[0].trim());
            const data = Object.values(currentResult.elements);
            const colors = Object.keys(currentResult.elements).map(e => elementColors[e]);
            
            charts.elements = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Panchamahabhutha Distribution',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateSignalTab() {
            if (!currentResult) return;
            
            const traces = [
                {
                    x: currentResult.time_axis,
                    y: currentResult.raw_signal,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Raw ECG',
                    line: { color: 'blue', width: 1 }
                },
                {
                    x: currentResult.time_axis,
                    y: currentResult.filtered_signal,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Filtered ECG',
                    line: { color: 'red', width: 2 }
                },
                {
                    x: currentResult.peak_times,
                    y: currentResult.peak_values,
                    type: 'scatter',
                    mode: 'markers',
                    name: `R-peaks (${currentResult.peak_times.length})`,
                    marker: { color: 'red', size: 6 }
                }
            ];
            
            const layout = {
                title: `Lead II ECG Signal - ${currentResult.sample_freq} Hz - HR: ${currentResult.heart_rate.toFixed(1)} BPM`,
                xaxis: { title: 'Time (seconds)' },
                yaxis: { title: 'Amplitude (V)' },
                showlegend: true
            };
            
            Plotly.newPlot('signalPlot', traces, layout, {responsive: true});
        }

        function updateHRVTab() {
            if (!currentResult) return;
            
            // HRV metrics chart
            const ctx = document.getElementById('hrvChart').getContext('2d');
            
            if (charts.hrv) {
                charts.hrv.destroy();
            }
            
            const hrvMetrics = ['RMSSD', 'SDNN', 'pNN50', 'Mean_RR'];
            const hrvValues = hrvMetrics.map(metric => currentResult.hrv_features[metric]);
            
            charts.hrv = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hrvMetrics,
                    datasets: [{
                        label: 'HRV Metrics',
                        data: hrvValues,
                        backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'],
                        borderColor: ['#FF5252', '#26C6DA', '#2196F3', '#66BB6A'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'HRV Time Domain Metrics'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // RR interval histogram
            const rrData = [{
                x: currentResult.rr_intervals,
                type: 'histogram',
                name: 'RR Intervals',
                marker: { color: 'skyblue' }
            }];
            
            const rrLayout = {
                title: 'RR Interval Distribution',
                xaxis: { title: 'RR Interval (ms)' },
                yaxis: { title: 'Frequency' }
            };
            
            Plotly.newPlot('rrHistogram', rrData, rrLayout, {responsive: true});
        }

        function compareFrequencies() {
            const fileId = document.getElementById('fileSelect').value;
            if (!fileId) return;
            
            const fileData = ecgData.results[fileId];
            const frequencies = Object.keys(fileData.frequencies).map(f => parseInt(f)).sort((a,b) => a-b);
            
            updateComparisonCharts(fileData, frequencies);
            showTab('comparison');
        }

        function updateComparisonCharts(fileData, frequencies) {
            // Heart Rate comparison
            const hrCtx = document.getElementById('hrComparisonChart').getContext('2d');
            if (charts.hrComparison) charts.hrComparison.destroy();
            
            const hrData = frequencies.map(f => fileData.frequencies[f].heart_rate);
            
            charts.hrComparison = new Chart(hrCtx, {
                type: 'bar',
                data: {
                    labels: frequencies.map(f => f + ' Hz'),
                    datasets: [{
                        label: 'Heart Rate (BPM)',
                        data: hrData,
                        backgroundColor: '#FF6B6B'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Heart Rate Comparison' } }
                }
            });
            
            // HRV comparison
            const hrvCtx = document.getElementById('hrvComparisonChart').getContext('2d');
            if (charts.hrvComparison) charts.hrvComparison.destroy();
            
            const rmssdData = frequencies.map(f => fileData.frequencies[f].hrv_features.RMSSD);
            
            charts.hrvComparison = new Chart(hrvCtx, {
                type: 'line',
                data: {
                    labels: frequencies.map(f => f + ' Hz'),
                    datasets: [{
                        label: 'RMSSD (ms)',
                        data: rmssdData,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'RMSSD Comparison' } }
                }
            });
            
            // FESI comparison
            const fesiCtx = document.getElementById('fesiComparisonChart').getContext('2d');
            if (charts.fesiComparison) charts.fesiComparison.destroy();
            
            const fesiData = frequencies.map(f => fileData.frequencies[f].fesi);
            
            charts.fesiComparison = new Chart(fesiCtx, {
                type: 'bar',
                data: {
                    labels: frequencies.map(f => f + ' Hz'),
                    datasets: [{
                        label: 'FESI Score',
                        data: fesiData,
                        backgroundColor: '#FF4757'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'FESI Comparison' } }
                }
            });
            
            // Elements comparison
            const elemCtx = document.getElementById('elementsComparisonChart').getContext('2d');
            if (charts.elementsComparison) charts.elementsComparison.destroy();
            
            const elements = Object.keys(currentResult.elements);
            const datasets = elements.map(element => {
                const data = frequencies.map(f => fileData.frequencies[f].elements[element]);
                return {
                    label: element.split('(')[0].trim(),
                    data: data,
                    backgroundColor: elementColors[element],
                    borderColor: elementColors[element],
                    borderWidth: 2
                };
            });
            
            charts.elementsComparison = new Chart(elemCtx, {
                type: 'radar',
                data: {
                    labels: frequencies.map(f => f + ' Hz'),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Elements Comparison' } },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Event listeners
        document.getElementById('fileSelect').addEventListener('change', updateDisplay);
        document.getElementById('frequencySelect').addEventListener('change', updateDisplay);

        // Load data on page load
        window.addEventListener('load', loadData);
    </script>
</body>
</html>